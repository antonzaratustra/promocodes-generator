<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="admin.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="utils.js"></script>
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</h1>
            <div class="filters">
                <div class="filter-group">
                    <label for="eventFilter">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:</label>
                    <select id="eventFilter">
                        <option value="all">–í—Å–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</option>
                        <option value="MRWRU">üá∑üá∫üçΩÔ∏èRestaurantWeek Moscow</option>
                        <option value="DRWRU">üá∑üá∫üçΩÔ∏èRestaurantWeek Dubai RU</option>
                        <option value="DRWEN">üåçüçΩÔ∏èRestaurantWeek Dubai ENG</option>
                        <option value="MSWRU">üá∑üá∫üíÖSalonWeek Moscow</option>
                        <option value="DSWRU">üá∑üá∫üíÖSalonWeek Dubai RU</option>
                        <option value="DSWEN">üåçüíÖSalonWeek Dubai ENG</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="yearFilter">–ì–æ–¥:</label>
                    <select id="yearFilter">
                        <option value="all">–í—Å–µ –≥–æ–¥—ã</option>
                        <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —Å –ø–æ–º–æ—â—å—é JavaScript -->
                    </select>
                </div>
                <button id="applyFilters" class="filter-btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
            </div>
        </header>

        <main>
            <div class="promo-codes-container">
                <table id="promoCodesTable" class="admin-table">
                    <thead>
                        <tr>
                            <th>–ü—Ä–æ–º–æ–∫–æ–¥</th>
                            <th>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</th>
                            <th>–ì–æ–¥</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th>–†–µ—Ñ–µ—Ä–∞–ª—ã</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="promoCodesTableBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é JavaScript -->
                        <tr class="loading-row">
                            <td colspan="6">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–∞–º–∏ -->
    <div id="referralsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ—Ñ–µ—Ä–∞–ª—ã –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É <span id="modalPromoCode"></span></h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="referrals-stats">
                    <div class="stat-item">
                        <span class="stat-label">–í—ã–ø–ª–∞—á–µ–Ω–æ:</span>
                        <span id="modalPaidAmount" class="stat-value">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–ö –æ–ø–ª–∞—Ç–µ:</span>
                        <span id="modalToPay" class="stat-value">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">–õ—é–¥–µ–π –ø—Ä–∏–≤–ª–µ—á–µ–Ω–æ:</span>
                        <span id="modalPeopleReferred" class="stat-value">-</span>
                    </div>
                </div>
                
                <div class="referrals-table-container">
                    <table id="modalReferralsTable" class="referrals-table">
                        <thead>
                            <tr>
                                <th>–í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã</th>
                                <th>ID –∑–∞–∫–∞–∑–∞</th>
                                <th>–ü—Ä–æ–¥—É–∫—Ç—ã</th>
                                <th>–ò–º—è –∫—É–ø–∏–≤—à–µ–≥–æ</th>
                                <th>–¶–µ–Ω–∞</th>
                                <th>Email</th>
                                <th>–í—ã–ø–ª–∞—Ç–∞</th>
                                <th>–û–ø–ª–∞—á–µ–Ω–æ</th>
                            </tr>
                        </thead>
                        <tbody id="modalReferralsTableBody">
                            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button id="saveChangesBtn" class="primary-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button id="closeModalBtn" class="secondary-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content delete-confirm">
            <div class="modal-header">
                <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥ <strong id="deletePromoCode"></strong>?</p>
                <p>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            </div>
            <div class="modal-footer">
                <button id="confirmDeleteBtn" class="danger-btn">–£–¥–∞–ª–∏—Ç—å</button>
                <button id="cancelDeleteBtn" class="secondary-btn">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        try {
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ Firebase...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ promoCodesCollection
            if (!promoCodesCollection) {
                throw new Error('–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
            
            console.log('promoCodesCollection path:', promoCodesCollection.path);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            const tableBody = document.getElementById('promoCodesTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="loading">
                        <div class="loading-spinner"></div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
                    </td>
                </tr>
            `;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å –≥–æ–¥–∞–º–∏
            populateYearSelect();
            
            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            console.log('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤...');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            const testQuery = await promoCodesCollection.limit(1).get();
            console.log('–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?', testQuery.empty);

            const snapshot = await promoCodesCollection
                .orderBy('createdAt', 'desc')
                .get();

            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', snapshot.size, '–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤');
            
            const promoCodes = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                console.log('–î–æ–∫—É–º–µ–Ω—Ç:', {
                    id: doc.id,
                    promoCode: data.promoCode,
                    eventCode: data.eventCode,
                    year: data.year,
                    createdAt: data.createdAt
                });
                promoCodes.push({
                    id: doc.id,
                    ...data
                });
            });

            console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º', promoCodes.length, '–ø—Ä–æ–º–æ–∫–æ–¥–æ–≤');
            renderPromoCodes(promoCodes);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
            showError(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
        }
    });

    function populateYearSelect() {
        const yearSelect = document.getElementById('yearFilter');
        const currentYear = new Date().getFullYear();
        
        yearSelect.innerHTML = '<option value="all">–í—Å–µ –≥–æ–¥—ã</option>';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ–¥–∞ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ + 2
        for (let year = currentYear; year <= currentYear + 2; year++) {
            const option = document.createElement('option');
            option.value = year.toString(); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ñ–æ—Ä–º–∞—Ç—É –≤ Firebase
            option.textContent = year;
            yearSelect.appendChild(option);
        }
    }

    async function loadPromoCodes() {
        try {
            console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤...');
            const snapshot = await promoCodesCollection
                .orderBy('createdAt', 'desc')
                .get();

            console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase:', snapshot.size, '–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤');
            
            const promoCodes = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                console.log('–î–æ–∫—É–º–µ–Ω—Ç:', data);
                promoCodes.push({
                    id: doc.id,
                    ...data
                });
            });

            renderPromoCodes(promoCodes);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
        }
    }

    function renderPromoCodes(promoCodes) {
        const tableBody = document.getElementById('promoCodesTableBody');
        tableBody.innerHTML = '';

        if (promoCodes.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="no-data">–ü—Ä–æ–º–æ–∫–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td>
                </tr>
            `;
            return;
        }

        promoCodes.forEach(promo => {
            const row = document.createElement('tr');
            const promoCode = promo.promoCode; // –ò–∑–≤–ª–µ–∫–∞–µ–º promoCode –∏–∑ –æ–±—ä–µ–∫—Ç–∞

            // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            const viewUrl = `referrals.html?event=${promo.eventCode}&year=${promo.year}&promo=${promoCode}`;
            const adminUrl = `${viewUrl}&admin=true`;

            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π URL —Å–∞–π—Ç–∞
            const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', '');
            const fullViewUrl = baseUrl + viewUrl;

            row.innerHTML = `
                <td>${promoCode || '-'}</td>
                <td>${getEventNameByCode(promo.eventCode)}</td>
                <td>${promo.year || '-'}</td>
                <td>${formatDate(promo.createdAt)}</td>
                <td>${promo.referralsCount || 0}</td>
                <td>
                    <div class="action-buttons">
                        <a href="${adminUrl}" class="view-btn">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</a>
                        <button class="copy-btn" data-url="${fullViewUrl}">üîó –°—Å—ã–ª–∫–∞</button>
                        <button class="delete-btn" data-id="${promo.id}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const url = this.dataset.url;
                navigator.clipboard.writeText(url).then(() => {
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-button-success';
                    copyButton.textContent = '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    setTimeout(() => {
                        copyButton.remove();
                    }, 2000);
                    document.body.appendChild(copyButton);
                }).catch(err => {
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-button-error';
                    copyButton.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è';
                    setTimeout(() => {
                        copyButton.remove();
                    }, 2000);
                    document.body.appendChild(copyButton);
                });
            });
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥?')) {
                    const id = this.dataset.id;
                    try {
                        await firebase.firestore()
                            .collection('promo-codes')
                            .doc(id)
                            .delete();
                        loadPromoCodes(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞');
                    }
                }
            });
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('applyFilters').addEventListener('click', async function() {
        const eventFilter = document.getElementById('eventFilter').value;
        const yearFilter = document.getElementById('yearFilter').value;
        
        console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã:', { eventFilter, yearFilter });
        
        try {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            const tableBody = document.getElementById('promoCodesTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="loading">
                        <div class="loading-spinner"></div>
                        –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤...
                    </td>
                </tr>
            `;

            let query = promoCodesCollection;
            
            // –°—Ç—Ä–æ–∏–º –∑–∞–ø—Ä–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
            if (eventFilter !== 'all' && yearFilter !== 'all') {
                console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–∞ —Ñ–∏–ª—å—Ç—Ä–∞:', { eventFilter, yearFilter });
                query = query
                    .where('eventCode', '==', eventFilter)
                    .where('year', '==', yearFilter)
                    .orderBy('createdAt', 'desc');
            } else if (eventFilter !== 'all') {
                console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:', eventFilter);
                query = query
                    .where('eventCode', '==', eventFilter);
            } else if (yearFilter !== 'all') {
                console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä –≥–æ–¥–∞:', yearFilter);
                query = query
                    .where('year', '==', yearFilter)
                    .orderBy('year', 'desc');
            } else {
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–æ–≤');
                query = query.orderBy('createdAt', 'desc');
            }
            
            const snapshot = await query.get();
            console.log('–ó–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª', snapshot.size, '–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤');
            
            const promoCodes = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                console.log('–ù–∞–π–¥–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç:', {
                    id: doc.id,
                    promoCode: data.promoCode,
                    eventCode: data.eventCode,
                    year: data.year,
                    createdAt: data.createdAt
                });
                promoCodes.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ JavaScript, –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤ Firebase
            if (eventFilter !== 'all' && yearFilter === 'all') {
                promoCodes.sort((a, b) => {
                    const dateA = new Date(a.createdAt).getTime();
                    const dateB = new Date(b.createdAt).getTime();
                    return dateB - dateA; // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
                });
            }
            
            console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º', promoCodes.length, '–ø—Ä–æ–º–æ–∫–æ–¥–æ–≤');
            renderPromoCodes(promoCodes);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
            if (error.message.includes('requires an index')) {
                const indexUrl = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]*/)[0];
                showError(`
                    –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤ Firebase. 
                    <a href="${indexUrl}" target="_blank">–°–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å</a>
                    <br><br>
                    –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.
                `);
            } else {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
            }
        }
    });

    function formatDate(timestamp) {
        if (!timestamp) return '-';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleString('ru-RU');
    }

    function showError(message) {
        const container = document.querySelector('.container');
        container.innerHTML = `
            <div class="error-message">
                <h2>–û—à–∏–±–∫–∞</h2>
                <p>${message}</p>
                <button onclick="location.reload()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>
        `;
    }

    async function fetchReferralData() {
        const promoCodeIndex = 0; // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å

        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbwo5NyUB3E1dSTibFGryEzKvGP8IEvuyec-Is3sFhaDa89ywcSSTfH578FHgkXOCgHqmw/exec?mode=fetch&eventCode=MRWRU&year=2025&promoCode=4444444444DAWD');
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data); // –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

            data.forEach(row => {
                console.log('–î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏:', row);
                const promoCode = row[promoCodeIndex];

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ promoCode —Å—Ç—Ä–æ–∫–æ–π
                if (typeof promoCode === 'string') {
                    console.log('–ü—Ä–æ–º–æ–∫–æ–¥:', promoCode.toUpperCase());
                } else {
                    console.error('promoCodeIndex –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π:', promoCode);
                }
            });
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
        }
    }
    </script>

    <style>
    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .view-btn {
        padding: 4px 8px;
        background-color: #4CAF50;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .copy-btn {
        padding: 4px 8px;
        background-color: #2196F3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .delete-btn {
        padding: 4px 8px;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .copy-button-success {
        background-color: #4CAF50;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }

    .copy-button-error {
        background-color: #f44336;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }

    .loading {
        text-align: center;
        padding: 20px;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    </style>
</body>
</html>
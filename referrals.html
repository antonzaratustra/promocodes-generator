<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">E2 Referrals</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="referrals.css">
    <script src="utils.js"></script>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.success {
            background-color: #4CAF50;
            color: white;
        }

        .notification.error {
            background-color: #f44336;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫ */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-button {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .action-button.view {
            background-color: #4CAF50;
            color: white;
        }

        .action-button.copy {
            background-color: #2196F3;
            color: white;
        }

        .action-button.delete {
            background-color: #f44336;
            color: white;
        }

        .back-button-container {
            margin-top: 10px;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background-color: #45a049;
        }

        .back-button svg {
            width: 20px;
            height: 20px;
        }

        .copy-button-success {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .copy-button-error {
            background-color: #f44336;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="eventTitle"></h1>
            <div class="back-button-container">
                <a href="admin.html" class="back-button" id="adminBackButton" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M15.41 16.09l-4.58-4.59 4.58-4.59L14 5.5l-6 6 6 6z"/>
                    </svg>
                    –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
                </a>
            </div>
        </header>
        
        <div class="referral-info">
            <div class="info-box">
                <div class="info-item">
                    <strong id="yearLabel">–ì–æ–¥:</strong>
                    <span id="yearInfo">-</span>
                </div>
                <div class="info-item">
                    <strong id="promoLabel">–ü—Ä–æ–º–æ–∫–æ–¥:</strong>
                    <span id="promoInfo">-</span>
                </div>
            </div>
            <div class="stats-box">
                <div class="stat-item">
                    <span class="stat-label" id="totalPaidLabel">–í—Å–µ–≥–æ –≤—ã–ø–ª–∞—á–µ–Ω–æ:</span>
                    <span id="totalPaid" class="stat-value">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label" id="totalPendingLabel">–í—Å–µ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ:</span>
                    <span id="totalPending" class="stat-value">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label" id="totalCommissionLabel">–í—Å–µ–≥–æ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–æ:</span>
                    <span id="totalCommission" class="stat-value">-</span>
                </div>
            </div>
        </div>
        
        <div class="referrals-table-container">
            <table id="referralsTable" class="referrals-table">
                <thead>
                    <tr>
                        <th id="headerTime">–í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã</th>
                        <th id="headerOrderId">ID –∑–∞–∫–∞–∑–∞</th>
                        <th id="headerProducts">–ü—Ä–æ–¥—É–∫—Ç—ã</th>
                        <th id="headerBuyer">–ò–º—è –∫—É–ø–∏–≤—à–µ–≥–æ</th>
                        <th id="headerPrice">–¶–µ–Ω–∞</th>
                        <th id="headerEmail">Email</th>
                        <th id="headerCommission">–í—ã–ø–ª–∞—Ç–∞</th>
                        <th id="headerPaid">–û–ø–ª–∞—á–µ–Ω–æ</th>
                    </tr>
                </thead>
                <tbody id="referralsTableBody">
                    <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é JavaScript -->
                    <tr class="loading-row">
                        <td colspan="8" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- Firebase —Å–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- –ù–∞—à–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase -->
    <script src="firebase-config.js"></script>
    
    <!-- –ù–∞—à–∏ —Å–∫—Ä–∏–ø—Ç—ã -->
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —è–∑—ã–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ç–æ–∫
        function setLanguage(eventCode) {
            const isEnglish = eventCode.endsWith('EN');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–∫–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –µ—Å–ª–∏ —ç—Ç–æ –∞–Ω–≥–ª–∏–π—Å–∫–∞—è –≤–µ—Ä—Å–∏—è
            if (isEnglish) {
                document.getElementById('yearLabel').textContent = 'Year:';
                document.getElementById('promoLabel').textContent = 'Promo code:';
                document.getElementById('totalPaidLabel').textContent = 'Total paid:';
                document.getElementById('totalPendingLabel').textContent = 'Total pending:';
                document.getElementById('totalCommissionLabel').textContent = 'Total referrals:';
                document.getElementById('headerTime').textContent = 'Payment time';
                document.getElementById('headerOrderId').textContent = 'Order ID';
                document.getElementById('headerProducts').textContent = 'Products';
                document.getElementById('headerBuyer').textContent = 'Buyer name';
                document.getElementById('headerPrice').textContent = 'Price';
                document.getElementById('headerEmail').textContent = 'Email';
                document.getElementById('headerCommission').textContent = 'Commission';
                document.getElementById('headerPaid').textContent = 'Paid';
                document.getElementById('pageTitle').textContent = 'E2 Referrals';
                document.getElementById('loadingText').textContent = 'Loading data...';
            } else {
                document.getElementById('yearLabel').textContent = '–ì–æ–¥:';
                document.getElementById('promoLabel').textContent = '–ü—Ä–æ–º–æ–∫–æ–¥:';
                document.getElementById('totalPaidLabel').textContent = '–í—ã–ø–ª–∞—á–µ–Ω–æ:';
                document.getElementById('totalPendingLabel').textContent = '–ö –æ–ø–ª–∞—Ç–µ:';
                document.getElementById('totalCommissionLabel').textContent = '–õ—é–¥–µ–π –ø—Ä–∏–≤–ª–µ—á–µ–Ω–æ:';
                document.getElementById('headerTime').textContent = '–í—Ä–µ–º—è –æ–ø–ª–∞—Ç—ã';
                document.getElementById('headerOrderId').textContent = 'ID –∑–∞–∫–∞–∑–∞';
                document.getElementById('headerProducts').textContent = '–ü—Ä–æ–¥—É–∫—Ç—ã';
                document.getElementById('headerBuyer').textContent = '–ò–º—è –∫—É–ø–∏–≤—à–µ–≥–æ';
                document.getElementById('headerPrice').textContent = '–¶–µ–Ω–∞';
                document.getElementById('headerEmail').textContent = 'Email';
                document.getElementById('headerCommission').textContent = '–í—ã–ø–ª–∞—Ç–∞';
                document.getElementById('headerPaid').textContent = '–û–ø–ª–∞—á–µ–Ω–æ';
                document.getElementById('pageTitle').textContent = 'E2 Referrals';
                document.getElementById('loadingText').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
            }
        }

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const eventCode = urlParams.get('event');
        const year = urlParams.get('year');
        const promoCode = urlParams.get('promo');
        const isAdmin = urlParams.get('admin') === 'true';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" —Ç–æ–ª—å–∫–æ –≤ –∞–¥–º–∏–Ω—Å–∫–æ–º —Ä–µ–∂–∏–º–µ
        if (isAdmin) {
            document.getElementById('adminBackButton').style.display = 'block';
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        if (eventCode) {
            const eventName = getEventNameByCode(eventCode);
            document.getElementById('eventTitle').innerText = eventName;
            setLanguage(eventCode);
        }

        console.log('Admin mode:', isAdmin);
        
        if (!eventCode || !year || !promoCode) {
            document.body.innerHTML = `
                <div class="error-page">
                    <h1>–û—à–∏–±–∫–∞</h1>
                    <p>–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</p>
                    <a href="index.html" class="error-link">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
                </div>
            `;
        } else {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            document.getElementById('yearInfo').textContent = year;
            document.getElementById('promoInfo').textContent = promoCode;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            fetchReferralData(eventCode, year, promoCode);
        }

        function getEventNameByCode(code) {
            const eventNames = {
                'MRWRU': 'RestaurantWeek –ú–æ—Å–∫–≤–∞',
                'DRWRU': 'RestaurantWeek –î—É–±–∞–π',
                'DRWEN': 'RestaurantWeek Dubai',
                'MSWRU': 'SalonWeek –ú–æ—Å–∫–≤–∞',
                'DSWRU': 'SalonWeek –î—É–±–∞–π',
                'DSWEN': 'SalonWeek Dubai'
            };
            return eventNames[code] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
        async function fetchReferralData(eventCode, year, promoCode) {
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ
                const loadingText = document.getElementById('loadingText');
                loadingText.textContent = eventCode.endsWith('EN') ? 'Loading data...' : '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö';
                
                const webhookUrl = getWebhookUrl(eventCode);
                const url = new URL(webhookUrl);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL
                url.searchParams.append('mode', 'fetch');
                url.searchParams.append('eventCode', eventCode);
                url.searchParams.append('year', year);
                url.searchParams.append('promoCode', promoCode);

                console.log('Fetching data from:', url.toString());

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const textData = await response.text();
                console.log('Received text data:', textData);
                
                // –ü–∞—Ä—Å–∏–º JSON –∏–∑ —Å—Ç—Ä–æ–∫–∏
                let parsedData;
                try {
                    parsedData = JSON.parse(textData);
                    console.log('Parsed data:', JSON.stringify(parsedData, null, 2));
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ JSON:', e);
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ
                if (parsedData.error) {
                    console.log('Error received from server:', parsedData.error);
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º —Å—Ç–æ–ª–±—Ü–∞ promocode, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É
                    if (parsedData.error.includes('–°—Ç–æ–ª–±–µ—Ü "promocode" –Ω–µ –Ω–∞–π–¥–µ–Ω')) {
                        console.log('No promocode column found, showing empty table');
                        renderReferralsTable([], eventCode, isAdmin);
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ 0
                        document.getElementById('totalPaid').textContent = '0';
                        document.getElementById('totalPending').textContent = '0';
                        document.getElementById('totalCommission').textContent = eventCode.endsWith('EN') ? '0 people' : '0 —á–µ–ª–æ–≤–µ–∫';
                        return;
                    }
                    throw new Error(parsedData.error);
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤
                const rawData = parsedData.data || [];
                console.log('Raw data:', JSON.stringify(rawData, null, 2));
                console.log('Raw data length:', rawData.length);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –ø–æ–ª–µ–º promocode
                const hasPromoCode = rawData.some(item => item && item.promocode !== undefined);
                
                if (!hasPromoCode) {
                    console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–ª–µ–º promocode, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é —Ç–∞–±–ª–∏—Ü—É');
                    renderReferralsTable([], eventCode, isAdmin);
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ 0
                    document.getElementById('totalPaid').textContent = '0';
                    document.getElementById('totalPending').textContent = '0';
                    document.getElementById('totalCommission').textContent = eventCode.endsWith('EN') ? '0 people' : '0 —á–µ–ª–æ–≤–µ–∫';
                    return;
                }

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                const processedData = Array.isArray(rawData) ? rawData.map(async item => {
                    console.log('Processing item:', JSON.stringify(item, null, 2));
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∏–∑ –æ—Ç–≤–µ—Ç–∞
                    const baseData = {
                        name: item.name,
                        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–æ–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
                        phonework: item.phonework || item.workphone,
                        email: item.email,
                        orderid: item.orderid,
                        paymentid: item.paymentid,
                        products: item.products,
                        price: item.price,
                        promocode: item.promocode,
                        discount: item.discount,
                        subtotal: item.subtotal,
                        –í–∞–ª—é—Ç–∞: item.–í–∞–ª—é—Ç–∞,
                        –°—Ç–∞—Ç—É—Å_–æ–ø–ª–∞—Ç—ã: item.–°—Ç–∞—Ç—É—Å_–æ–ø–ª–∞—Ç—ã,
                        referer: item.referer,
                        formid: item.formid,
                        –ù–∞–∑–≤–∞–Ω–∏–µ_—Ñ–æ—Ä–º—ã: item.–ù–∞–∑–≤–∞–Ω–∏–µ_—Ñ–æ—Ä–º—ã,
                        sent: item.sent,
                        requestid: item.requestid,
                        isPaid: false // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é false
                    };

                    // –ï—Å–ª–∏ –µ—Å—Ç—å orderid, –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –∏–∑ Firebase
                    if (item.orderid) {
                        try {
                            const paymentRef = db.collection('payments').doc(item.orderid);
                            const paymentDoc = await paymentRef.get();
                            if (paymentDoc.exists) {
                                baseData.isPaid = paymentDoc.data().isPaid;
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã:', error);
                        }
                    }

                    return baseData;
                }) : [];

                // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
                const finalData = await Promise.all(processedData);
                
                console.log('Final processed data:', JSON.stringify(finalData, null, 2));
                console.log('Final data length:', finalData.length);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –ø—É—Å—Ç—ã–µ
                if (finalData.length > 0) {
                    console.log('Rendering data with length:', finalData.length);
                    renderReferralsTable(finalData, eventCode, isAdmin);
                    updateStats(eventCode);
                } else {
                    console.log('No data received');
                    renderReferralsTable([], eventCode, isAdmin);
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ 0
                    document.getElementById('totalPaid').textContent = '0';
                    document.getElementById('totalPending').textContent = '0';
                    document.getElementById('totalCommission').textContent = eventCode.endsWith('EN') ? '0 people' : '0 —á–µ–ª–æ–≤–µ–∫';
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏
        function copyLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                showNotification('–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }).catch(err => {
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 'error');
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
        function renderReferralsTable(data, eventCode, isAdmin) {
            console.log('Rendering referrals table with data:', JSON.stringify(data, null, 2));
            console.log('Event code:', eventCode);
            console.log('Is admin:', isAdmin);
            
            const tableBody = document.getElementById('referralsTableBody');
            if (!tableBody) {
                console.error('Table body not found');
                return;
            }
            
            tableBody.innerHTML = '';

            if (!data || !Array.isArray(data) || data.length === 0) {
                console.log('No data to display');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">
                            ${eventCode.endsWith('EN') 
                                ? 'No data found. This may be because:'
                                : '–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ:'}
                            <ul>
                                <li>${eventCode.endsWith('EN') 
                                    ? 'No purchases have been made with this promo code yet'
                                    : '–ü–æ —ç—Ç–æ–º—É –ø—Ä–æ–º–æ–∫–æ–¥—É –µ—â–µ –Ω–µ—Ç –ø–æ–∫—É–ø–æ–∫'}</li>
                                <li>${eventCode.endsWith('EN') 
                                    ? 'The data has not been synchronized yet'
                                    : '–î–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã'}</li>
                                <li>${eventCode.endsWith('EN') 
                                    ? 'There was a temporary server connection error'
                                    : '–í–æ–∑–Ω–∏–∫–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º'}</li>
                            </ul>
                        </td>
                    </tr>
                `;
                return;
            }

            const currency = eventCode.endsWith('EN') ? '$' : '‚ÇΩ';
            console.log('Using currency:', currency);

            data.forEach((item, index) => {
                console.log(`Processing table item #${index}:`, JSON.stringify(item, null, 2));
                const commission = parseFloat(item.price) * 0.05;
                const orderId = item.orderid ? String(item.orderid).toUpperCase() : '-';
                
                const row = document.createElement('tr');
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –≤ —Å—Ç–æ–ª–±—Ü–µ "–û–ø–ª–∞—á–µ–Ω–æ"
                const paidContent = isAdmin
                    ? `<input type="checkbox" class="paid-checkbox" data-orderid="${item.orderid}" ${item.isPaid ? 'checked' : ''}>`
                    : (item.isPaid ? '‚úÖ' : '‚è≥');

                // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                const viewUrl = `${window.location.origin}${window.location.pathname}?event=${eventCode}&year=${new Date(item.sent).getFullYear()}&promo=${item.promocode}`;
                const adminUrl = `${viewUrl}&admin=true`;

                // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
                const actions = `
                    <div class="action-buttons">
                        <button onclick="window.location.href='${adminUrl}'" class="action-button view">üëÅÔ∏è View</button>
                        <button onclick="copyLink('${viewUrl}')" class="action-button copy">üîó Copy link</button>
                        ${isAdmin ? `<button onclick="deleteReferral('${item.orderid}')" class="action-button delete">üóëÔ∏è Delete</button>` : ''}
                    </div>
                `;

                console.log('Row data:', {
                    date: formatDate(item.sent),
                    orderId: orderId,
                    products: item.products,
                    name: item.name,
                    price: item.price,
                    email: item.email,
                    commission: commission,
                    paidContent: paidContent
                });

                row.innerHTML = `
                    <td>${formatDate(item.sent)}</td>
                    <td>${orderId}</td>
                    <td>${item.products || '-'}</td>
                    <td>${item.name || '-'}</td>
                    <td>${item.price} ${currency}</td>
                    <td>${item.email || '-'}</td>
                    <td>${commission.toFixed(2)} ${currency}</td>
                    <td>${paidContent}</td>
                `;
                
                tableBody.appendChild(row);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤, –µ—Å–ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω
            if (isAdmin) {
                console.log('Adding checkbox handlers');
                document.querySelectorAll('.paid-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const orderId = this.dataset.orderid;
                        const isChecked = this.checked;
                        console.log('Updating payment status for orderId:', orderId, 'to', isChecked);
                        // –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ—É–Ω–∫—Ü–∏—é updatePaymentStatus
                        updatePaymentStatus(orderId, isChecked, data);
                    });
                });
            }
        }

        function getDataFromTable() {
            const tableBody = document.getElementById('referralsTableBody');
            if (!tableBody) return [];

            const data = [];
            const rows = tableBody.getElementsByTagName('tr');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
            if (rows.length === 0 || rows[0].classList.contains('no-data')) {
                return [];
            }
            
            for (let row of rows) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ (–Ω–µ —Å—Ç—Ä–æ–∫–∞ "–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                if (row.classList.contains('no-data')) {
                    continue;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —á–µ–∫–±–æ–∫—Å (–∞–¥–º–∏–Ω —Ä–µ–∂–∏–º)
                const checkbox = row.querySelector('input[type="checkbox"]');
                const isPaid = checkbox ? checkbox.checked : row.cells[row.cells.length - 1].textContent === '‚úÖ';
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É
                const priceCell = row.cells[4];
                const price = priceCell ? parseFloat(priceCell.textContent.replace(/[^\d.]/g, '')) : 0;
                
                data.push({
                    price: price,
                    isPaid: isPaid
                });
            }
            
            return data;
        }

        function updateStats(eventCode) {
            const currency = eventCode.endsWith('EN') ? '$' : '‚ÇΩ';
            const data = getDataFromTable();

            // –°—á–∏—Ç–∞–µ–º –≤—ã–ø–ª–∞—Ç—ã –ø–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º –∑–∞–∫–∞–∑–∞–º
            const totalPaid = data
                .filter(item => item.isPaid)
                .reduce((sum, item) => sum + item.price * 0.05, 0);

            // –°—á–∏—Ç–∞–µ–º –≤—ã–ø–ª–∞—Ç—ã –ø–æ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–º –∑–∞–∫–∞–∑–∞–º
            const totalPending = data
                .filter(item => !item.isPaid)
                .reduce((sum, item) => sum + item.price * 0.05, 0);

            // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –ª—é–¥–µ–π
            let totalPeople = data.length;

            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 0
            const paidValue = totalPaid > 0 ? `${totalPaid.toFixed(2)} ${currency}` : '0';
            const pendingValue = totalPending > 0 ? `${totalPending.toFixed(2)} ${currency}` : '0';
            let peopleValue = totalPeople > 0 ? `${totalPeople} ${eventCode.endsWith('EN') ? 'people' : '—á–µ–ª–æ–≤–µ–∫'}` : `${eventCode.endsWith('EN') ? '0 people' : '0 —á–µ–ª–æ–≤–µ–∫'}`;

            document.getElementById('totalPaid').textContent = paidValue;
            document.getElementById('totalPending').textContent = pendingValue;
            document.getElementById('totalCommission').textContent = peopleValue;
        }

        async function updatePaymentStatus(orderId, isPaid, data) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Firebase –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã
                const paymentRef = db.collection('payments').doc(orderId);
                
                await paymentRef.set({
                    orderId: orderId,
                    isPaid: isPaid,
                    updated_at: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });

                console.log('Payment status updated successfully');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
                const tableBody = document.getElementById('referralsTableBody');
                if (tableBody) {
                    const row = Array.from(tableBody.getElementsByTagName('tr'))
                        .find(row => row.querySelector(`input[data-orderid="${orderId}"]`));
                    
                    if (row) {
                        const checkbox = row.querySelector('input[type="checkbox"]');
                        checkbox.checked = isPaid;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–∏—Å—Å–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏
                        const price = parseFloat(row.cells[4].textContent.replace(/[^\d.]/g, ''));
                        const commission = price * 0.05;
                        const commissionCell = row.cells[row.cells.length - 2];
                        const currency = commissionCell.textContent.split(' ')[1];
                        commissionCell.textContent = `${commission.toFixed(2)} ${currency}`;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats(eventCode);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã');
            }
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleString('ru-RU', {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function formatReferer(url) {
            try {
                const parsedUrl = new URL(url);
                return parsedUrl.hostname;
            } catch {
                return url || '-';
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
        }

        function getWebhookUrl(eventCode) {
            switch(eventCode) {
                case 'MRWRU':
                case 'DRWRU':
                    return 'https://script.google.com/macros/s/AKfycbyQ5MtTihCrZvKprNlg2aovafN5MNB8Fm9D_TRB1ktC4QdU-XrqkFF5hCMwiJFZFfvubg/exec';
                case 'DRWEN':
                    return 'https://script.google.com/macros/s/AKfycbx_dS3fs7pU3Z2_TayzjHGvw4srEsZC-zeZL_zdF-9GyFXcwjhGDuVAPiXGhKMDMqAsOg/exec';
                case 'MSWRU':
                case 'DSWRU':
                    return 'https://script.google.com/macros/s/AKfycbyFyDa80mQ4h6d0ilIWJdKhLLaTZ90ImMBBHKuaqzJbB_hS8gZYAWEBgof4O8TWk8_E/exec';
                case 'DSWEN':
                    return 'https://script.google.com/macros/s/AKfycbxxS868ikkxqatEFWvoc7uv9VHNxMD49kLlalIz2PKnaPQy1Leb5dAUpV96LzLoK4lZ/exec';
                default:
                    throw new Error('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
            }
        }
    </script>
</body>
</html>